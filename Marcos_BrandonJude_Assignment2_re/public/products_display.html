<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fruit Store</title>
    <script src="/product_data.js"></script>
    <link rel="stylesheet" href="./products_styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap" rel="stylesheet">
</head>

<!-- This file will load the order page with product data and prices -->

<style>
    html,
    body {
        background-image: linear-gradient(to top, #92c8fa, white);
        height: 100%;
    }


    ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #2371DC;
    }

    li {
        float: left;
    }

    li a {
        font-family: 'Montserrat', sans-serif;
        display: block;
        color: white;
        text-align: center;
        padding: 14px 16px;
        text-decoration: none;
    }

    li a:hover {
        background-color: #739fde;
    }

    #login_button,
    #logout_button,
    #shopping_cart {
        float: right;
    }
</style>

<script>

    let params = (new URL(document.location)).searchParams;
    if (params.has('product_type')) {
        var product_type = params.get('product_type');
    } else {
        alert('Must have a product key to display products!');
        window.stop;
    }
</script>

<script>
    //when the page loads, check the URL for existence of paramters
    window.onload = function () {

        let params = (new URL(document.location)).searchParams;
        product_form = params.get('product');
        //if the alert parameter exists, load an alert on the client browser

        if (params.has("errors")) {
            var errors = JSON.parse(params.get('errors'));
            if (Object.keys(errors).length == 0) {
                alert('Items successfully added to cart!');
            } else {
                // document.getElementsByName(`quantity_textbox_of_${params.get('product_name')}`).value = params.get(`quantity_textbox_of_${params.get('product_name')}`);
                let quantities = params.get('quantity').split(',');
                for (i in quantities){
                    document.getElementById(`quantity_${i}`).value = quantities[i];
                    if (typeof errors[`quantity_${i}`] != 'undefined') {
                        document.getElementById(`error_div_quantity_${i}`).innerHTML = errors[`quantity_${i}`]; 
                    }
                    
                }
                
                alert('Could not add to cart. Please fix errors below.');
                
            }

        }
    }


    function navigationbar() {

        document.write(`
        <div id="nav">
            <ul>`);

        for (p_key in products_array) {
            document.write(`
            <li><a href="./products_display.html?product_type=${p_key}">${p_key}</a></li>

        `);
        }

        document.write(`

        <li id="shopping_cart" class="shopping_cart"><a href="./shopping_cart.html">Cart</a></li>
        <li id="login_button" class="login_button"><a href="./login.html">Login</a></li>
        <li id="logout_button" class="logout_button"><a href="/logout">Logout</a></li>

        </ul>
        `);

    }








</script>


<body>

    <div class="header_container">
        <h1>Brandon's Premium Fruit Store</h1>
    </div>

    <script type="text/javascript">navigationbar();</script>

    <div class="welcome_container">
        <h3>Welcome! Shop below for the products fruit on Earth!</h3>
    </div>

    <br>
    <br>


    <!-- Iterate through each product from the JSON products file and create its section on the order page -->
    <form name="product_${i}" action="/add_to_cart" method="post">

        <script>


            // product_key as a hidden input so server can get products_array quantity
            document.write(`<input type="hidden" name="product_type" value="${product_type}">`);
            //setting up the form with for statement
            //load the product information into the order page with for loop
            document.write(`<div class="item_container">`)
            for (i = 0; i < products_array[product_type].length; i++) {
                document.write(`
                    <div class="item">
                        
                        <img class="item_image" src="${products_array[product_type][i].image}">
                        <p class="item_name">${products_array[product_type][i].name}</p>
                        <p class="item_price">$${products_array[product_type][i].price}</p>
                        <label for="quantity_input">Qty</label>
                        <input type="text" id="quantity_${i}" value="0" name="quantity[${i}]"></input>
                        <div id="error_div_quantity_${i}">
                        </div>
                        <p>In Stock: ${products_array[product_type][i].quantity_available}</p>
        
                        
                    
                        
                    

                    </div>
                
                </div>

                `);
            }


        </script>
        <input type="submit" name="submit_button" value="Add Items to Cart">
    </form>



</body>

</html>